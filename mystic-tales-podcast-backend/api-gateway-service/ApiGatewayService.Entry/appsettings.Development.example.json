{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AppSettings": {
    "APP_PORT": 8041,
    "APP_BASE_URL": "http://localhost:8041",
    "HEALTH_CHECK_ENDPOINT": "/health",
    "RESET_PASSWORD": {
      "Url": "http://localhost:3007/reset-password",
      "TokenExpiredInMinutes": 30
    },
    "IMAGE_SRC": "local", // awsS3 or local
    "DEFAULT_AUTHENTICATION": {
      "Scheme": "Jwt_PublicPrivateKeyAuth"
    },
    "DEFAULT_AUTHORIZATION": {
      "Policy": "LoginRequired"
    },
    "TIME_ZONE": "Asia/Ho_Chi_Minh",
    "EMBEDDING_VECTOR_API_URL": "http://embedding-vector-service-api.surveytalk.io.vn:8000/v1",
  },
  "AllowedHosts": "*",
  "Jwt": {
    "SecretKey": "",
    "Issuer": "localhost",
    "Exp": 100000000,
    "Audience": "localhost",
    "AccessTokenExpiration": 30,
    "RefreshTokenExpiration": 60,
    "OpenSSL_PrivateKey_Path": "AppConfigurations\\Jwt\\keys\\private_key.pem",
    "OpenSSL_PublicKey_Path": "AppConfigurations\\Jwt\\keys\\public_key.pem"
  },
  "Infrastructure": {
    "Redis": {
      "Default": {
        "ConnectionString": "localhost:6380",
        "SharedKeyName": "MTP:Shared",
        "InstanceKeyName": "MTP:ApiGatewayService",
        "DefaultDatabase": 0,
        "ConnectTimeout": 5000,
        "SyncTimeout": 5000,
        "AbortOnConnectFail": false,
        "ConnectRetry": 3,
        "UseSsl": false,
        "Password": ""
      },
      "Cache": {
        "KeyPrefix": "gateway:cache:",
        "DefaultExpirationMinutes": 30,
        "EnableCompression": false,
        "SerializationFormat": "JSON",
        "YarpRoutesKey": "yarp:routes",
        "YarpClustersKey": "yarp:clusters", 
        "YarpConfigurationKey": "yarp:configuration",
        "ServiceEndpointsKey": "consul:service-endpoints",
        "StaleKeyPrefix": "stale:",
        "ServiceEndpointsTtlSeconds": 45,
        "StaleCacheTtlSeconds": 1800
      },
      "RateLimit": {
        "DefaultLimit": 1000,
        "WindowMinutes": 1,
        "EnableRateLimit": true
      },
      "Session": {
        "SessionTimeoutMinutes": 30,
        "SessionCookieName": "ApiGatewayService.Session",
        "IsEssential": true,
        "HttpOnly": true,
        "SecurePolicy": "SameAsRequest"
      },
      "MessageQueue": {
        "QueuePrefix": "queue:",
        "DefaultTtlMinutes": 60,
        "MaxRetryAttempts": 3,
        "RetryDelaySeconds": 5,
        "EnableDeadLetterQueue": true,
        "DeadLetterQueuePrefix": "dlq:"
      },
      "Lock": {
        "LockPrefix": "lock:",
        "DefaultLockTimeoutSeconds": 30,
        "LockRetryDelayMilliseconds": 100,
        "MaxLockRetryAttempts": 50,
        "EnableLockMetrics": true
      },
      "Analytics": {
        "AnalyticsPrefix": "analytics:",
        "BatchSize": 100,
        "FlushIntervalSeconds": 60,
        "RetentionDays": 30,
        "EnableRealTimeAnalytics": true,
        "EnableMetrics": true
      },
      "Config": {
        "ConfigPrefix": "config:",
        "ConfigCacheMinutes": 15,
        "EnableConfigCaching": true,
        "EnableConfigVersioning": true,
        "MaxConfigVersions": 10
      },
      "JobQueue": {
        "JobQueuePrefix": "job:",
        "MaxConcurrentJobs": 10,
        "JobTimeoutMinutes": 30,
        "RetryDelaySeconds": 5,
        "MaxRetryAttempts": 3,
        "EnableJobPersistence": true
      }
    },
    "Consul": {
      "Service": {
        "Host": "http://localhost:8501",
        "Id": "api-gateway-service-dev-001",
        "ServiceName": "api-gateway-service", 
        "ServiceScheme": "http",
        "Tags": ["api", "gateway", "yarp", "redis", "reverse-proxy", "microservice"],
        "Version": "1.0.0",
        "DestinationInstancePattern": "{serviceName}-{environment}-{instanceNumber:D3}",
        "DestinationEnvironment": "dev"
      },
      "DistributedLock": {
        // chú thích: T_cycle (thời gian chu kì của job), T_exec (thời gian thực thi job ước tính)
        // TTL = MAX(T_exec × 2 + Buffer, T_cycle × 1.5) , Buffer là thời gian đệm (ví dụ 15s)
        // RenewalInterval = TTL / 3
        // WaitTimeout = MIN(T_exec, 500ms) , 500ms là giới hạn tối đa 500ms (đảm bảo không chờ quá lâu trường hợp lock đã bị acquire bởi instance khác rồi)
        // RetryDelay = MAX(T_network × 2, 500ms) , 500ms là giới hạn tối thiểu 500ms để tránh retry spam
        "LockKeyPrefix": "locks/user-service/",
        "DefaultLockShortTTLSeconds": 120,
        "DefaultLockLongTTLSeconds": 300,
        "DefaultLockShortRenewalIntervalSeconds": 40,
        "DefaultLockLongRenewalIntervalSeconds": 100,
        "DefaultLockWaitTimeoutSeconds": 0.5, // thời gian chờ để có thể acquire lock (try acquire lock nhiều lần trong khoảng thời gian này)
        "DefaultLockRetryDelaySeconds": 0.16 // thời gian chờ giữa các lần try (acquire lock)
      },
      "HealthCheck": {
        "Enabled": true,
        "Name": "api-gateway-service-health",
        "Notes": "Health check for API Gateway Service - YARP Reverse Proxy",
        "BaseUrl": "http://host.docker.internal:8041",
        "IntervalSeconds": 10,
        "TimeoutSeconds": 5,
        "DeregisterCriticalServiceAfter": 300
      }
    },
    "Yarp": {
      "ReverseProxy": {
        "EnableCaching": true,
        "DefaultCacheTtlMinutes": 5,
        "EnableCompression": true,
        "TimeoutSeconds": 30,
        "MaxRequestBodySize": 104857600,
        "EnableRequestBuffering": false,
        "LoadBalancing": {
          "DefaultPolicy": "RoundRobin",
          "HealthCheckIntervalSeconds": 30,
          "FailureThreshold": 3,
          "RecoveryThreshold": 2,
          "EnableSessionAffinity": false,
          "SessionAffinityFailurePolicy": "Redistribute",
          "TimeoutMilliseconds": 30000
        },
        "HealthCheck": {
          "EnableHealthChecks": true,
          "HealthCheckPath": "/health",
          "HealthCheckIntervalSeconds": 30,
          "HealthCheckTimeoutSeconds": 5,
          "UnhealthyThreshold": 3,
          "HealthyThreshold": 2,
          "EnablePassiveHealthChecks": true,
          "RequiredHeaders": []
        }
      },
      "Routing": {
        "EnableDynamicRouting": true,
        "RouteRefreshIntervalSeconds": 15,
        "DefaultRoutePrefix": "/api",
        "EnableRouteMetrics": true,
        "EnableRouteLogging": true,
        "ExcludedRoutePatterns": ["/health", "/metrics", "/swagger"],
        "EligibleServiceTags": ["api", "microservice"],
        "ExcludedServiceNames": ["consul", "api-gateway"],
        "DefaultServiceScheme": "http",
        "RefreshRetryDelaySeconds": 5,
        "MaxRetryAttempts": 3
      }
    }
  }
}
